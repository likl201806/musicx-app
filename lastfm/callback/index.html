<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>正在返回 MusicX…</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC",
        "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      color: #111;
    }
    .card {
      width: 100%;
      max-width: 560px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      padding: 22px;
    }
    h1 { margin: 0 0 10px; font-size: 18px; color: #2b2b2b; }
    p { margin: 8px 0; line-height: 1.5; color: #333; }
    code {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      background: #f3f4ff;
      color: #3b3bb3;
      word-break: break-all;
    }
    .btn {
      display: inline-block;
      margin-top: 14px;
      padding: 10px 14px;
      border-radius: 10px;
      background: #667eea;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
    }
    .btn:active { transform: translateY(1px); }
    .muted { color: #666; font-size: 13px; }
    .error { color: #b00020; }
    .row { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">正在返回 MusicX…</h1>
    <p id="status">请稍候，我们将自动打开 MusicX。</p>

    <div class="row" id="tokenRow" style="display:none;">
      <p class="muted">收到的 token：</p>
      <p><code id="tokenText"></code></p>
    </div>

    <div class="row" id="fallbackRow" style="display:none;">
      <a class="btn" id="openBtn" href="#">打开 MusicX</a>
      <p class="muted">如果没有弹出“打开 MusicX？”，请点击按钮。</p>
    </div>

    <div class="row" id="errorRow" style="display:none;">
      <p class="error" id="errorText"></p>
      <p class="muted">你可以返回 App 里重新发起 Last.fm 登录。</p>
    </div>
  </div>

  <script>
    (function () {
      var params = new URLSearchParams(window.location.search);
      // Last.fm web-based auth 常见回调参数：token
      var token = params.get("token");
      // 兼容一些实现会返回 error / error_description
      var err = params.get("error");
      var errDesc = params.get("error_description");

      var titleEl = document.getElementById("title");
      var statusEl = document.getElementById("status");
      var tokenRow = document.getElementById("tokenRow");
      var tokenText = document.getElementById("tokenText");
      var fallbackRow = document.getElementById("fallbackRow");
      var openBtn = document.getElementById("openBtn");
      var errorRow = document.getElementById("errorRow");
      var errorText = document.getElementById("errorText");

      function showError(msg) {
        titleEl.textContent = "无法返回 MusicX";
        statusEl.textContent = "";
        errorRow.style.display = "block";
        errorText.textContent = msg;
      }

      if (err) {
        showError("授权失败：" + err + (errDesc ? ("（" + errDesc + "）") : ""));
        return;
      }

      if (!token) {
        showError("未在回调 URL 中找到 token（例如 ?token=XXXX）。");
        return;
      }

      tokenRow.style.display = "block";
      tokenText.textContent = token;

      var deepLink = "musicx://auth/lastfm?token=" + encodeURIComponent(token);
      openBtn.href = deepLink;

      // 尝试自动打开（部分浏览器/系统可能拦截非用户手势触发的 scheme）
      var opened = false;
      function onVisibilityChange() {
        if (document.hidden) opened = true;
      }
      document.addEventListener("visibilitychange", onVisibilityChange);

      // 立刻触发一次自动跳转
      window.location.href = deepLink;

      // 兜底：若未切到后台，展示按钮让用户点击
      window.setTimeout(function () {
        document.removeEventListener("visibilitychange", onVisibilityChange);
        if (!opened) {
          titleEl.textContent = "请点击返回 MusicX";
          statusEl.textContent = "自动打开可能被浏览器拦截。";
          fallbackRow.style.display = "block";
        }
      }, 900);
    })();
  </script>
</body>
</html>

